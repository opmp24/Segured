<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#fbbf24" />
  <title>Inventario — NM Soluciones Integrales</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="manifest" href="/manifest.json">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body class="d-flex flex-column min-vh-100">
  <nav></nav>

  <!-- Page Header -->
  <section class="container-fluid bg-dark text-white py-5 mb-5 position-relative overflow-hidden hero-parallax text-center" style="background-image: url('../assets/images/muelle03.jpeg');">
    <div class="container py-5 reveal">
      <span class="text-warning fw-bold text-uppercase">Gestión</span>
      <h1 class="display-4 fw-bold">Inventario QR</h1>
      <p class="lead text-white-50 col-lg-8 mx-auto">Escanea códigos de productos para obtener información y gestionar el inventario.</p>
    </div>
  </section>

  <main class="container py-4">
    <!-- Sección del Escáner -->
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3"><i class="bi bi-qr-code-scan me-2 text-warning"></i>Escanear Código</h5>
                    <div id="reader" style="width: 100%; min-height: 300px; background: #f8f9fa; border-radius: 8px;"></div>
                    <p class="text-muted small mt-2">Permite el acceso a la cámara para escanear códigos QR o de barras.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de Resultados (Oculta inicialmente) -->
    <div id="result-section" class="row justify-content-center d-none reveal">
        <div class="col-md-8">
            <div class="card shadow border-0">
                <div class="card-header bg-warning text-dark fw-bold">
                    <i class="bi bi-box-seam me-2"></i>Detalles del Producto
                </div>
                <div class="card-body">
                    <form id="inventory-form">
                        <div class="mb-3">
                            <label for="scanned-code" class="form-label fw-bold">Código Escaneado</label>
                            <div class="input-group">
                                <input type="text" class="form-control bg-light" id="scanned-code" readonly>
                                <a href="#" id="google-search-btn" target="_blank" class="btn btn-outline-secondary" title="Buscar en Google"><i class="bi bi-google"></i></a>
                            </div>
                            <div class="form-text">Si los datos no se cargan automáticamente, usa el botón de Google.</div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="product-name" class="form-label">Nombre del Producto</label>
                                <input type="text" class="form-control" id="product-name" placeholder="Ej: Casco de Seguridad">
                            </div>
                            <div class="col-md-6">
                                <label for="product-brand" class="form-label">Marca</label>
                                <input type="text" class="form-control" id="product-brand" placeholder="Ej: 3M">
                            </div>
                            <div class="col-md-6">
                                <label for="product-price" class="form-label">Precio Estimado</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="product-price" placeholder="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="product-measures" class="form-label">Medidas / Talla</label>
                                <input type="text" class="form-control" id="product-measures" placeholder="Ej: L, 20x20cm">
                            </div>
                        </div>
                        <div class="mt-4 text-end">
                            <button type="button" class="btn btn-outline-dark me-2" onclick="resetScanner()">Escanear Otro</button>
                            <button type="button" class="btn btn-warning fw-bold" onclick="alert('Funcionalidad de guardado pendiente de backend.')">Guardar en Inventario</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
  </main>

  <footer></footer>
  <div id="whatsapp-placeholder"></div>
  
  <script src="/drive-config.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Librería para lectura de QR -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  
  <script>
    let html5QrcodeScanner;

    function onScanSuccess(decodedText, decodedResult) {
        // Detener el escaneo al encontrar un código
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear();
        }

        // Mostrar sección de resultados
        document.getElementById('result-section').classList.remove('d-none');
        document.getElementById('scanned-code').value = decodedText;
        // Configurar botón de búsqueda en Google como respaldo
        document.getElementById('google-search-btn').href = `https://www.google.com/search?q=${encodeURIComponent(decodedText)}`;

        // Buscar datos en internet (Open Food Facts API como ejemplo gratuito)
        fetchProductData(decodedText);
    }

    async function fetchProductData(code) {
        const nameInput = document.getElementById('product-name');
        const brandInput = document.getElementById('product-brand');
        const measuresInput = document.getElementById('product-measures');
        
        nameInput.value = 'Buscando información...';
        
        try {
            const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
            const data = await response.json();

            if (data.status === 1) {
                const p = data.product;
                nameInput.value = p.product_name || '';
                brandInput.value = p.brands || '';
                measuresInput.value = p.quantity || '';
            } else {
                nameInput.value = ''; // No encontrado, dejar vacío para ingreso manual
            }
        } catch (error) {
            console.warn('Error consultando API:', error);
            nameInput.value = '';
        }
    }

    function resetScanner() {
        document.getElementById('result-section').classList.add('d-none');
        document.getElementById('inventory-form').reset();
        startScanner();
    }

    function startScanner() {
        // Inicializar escáner
        html5QrcodeScanner = new Html5QrcodeScanner(
            "reader",
            { fps: 10, qrbox: {width: 250, height: 250} },
            /* verbose= */ false);
        html5QrcodeScanner.render(onScanSuccess, (error) => {
            // Ignorar errores de lectura frame a frame
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        startScanner();
    });
  </script>
  
  <script src="/app.js" defer></script>
  <script src="../main.js" defer></script>
</body>
</html>